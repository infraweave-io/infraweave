name: Test (Reusable)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_VERBOSE: true
  K8S_OPENAPI_ENABLED_VERSION: v1.31

jobs:
  build-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Install nextest
        run: cargo install cargo-nextest --locked

      - name: Build nextest archive
        run: cargo nextest archive --archive-file nextest-archive.tar.zst --cargo-profile ci-tests

      - name: Upload nextest archive
        uses: actions/upload-artifact@v4
        with:
          name: nextest-archive
          path: nextest-archive.tar.zst

  unit-tests:
    needs: build-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: false

      - name: Download archive
        uses: actions/download-artifact@v4
        with:
          name: nextest-archive

      - name: Run unit tests
        run: >- 
          cargo nextest run --archive-file nextest-archive.tar.zst 
          -E "kind(lib) + kind(bin)"

  integration-tests-matrix:
    runs-on: ubuntu-latest
    outputs:
      tests: ${{ steps.set-matrix.outputs.tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create integration tests list
        id: set-matrix
        run: |
          cd integration-tests/tests
          tests=$(grep -l -E '#\[(tokio::)?test\]' *.rs 2>/dev/null | xargs -I{} basename {} .rs | awk 'BEGIN{printf "["} {if(NR>1)printf ","; printf "\"%s\"", $0} END{printf "]"}')
          echo "tests=$tests" >> $GITHUB_OUTPUT
          
          echo "Integration tests matrix:"
          echo "$tests" | jq '.'

  integration-test:
    name: ${{ matrix.provider.PROVIDER }} (${{ matrix.test }})
    needs: [build-tests, integration-tests-matrix]
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE_MIRROR: ghcr.io/${{ github.repository }}
    strategy:
      fail-fast: false
      matrix:
        provider:
          - PROVIDER: aws
            INFRAWEAVE_ENV: dev
            INFRAWEAVE_API_FUNCTION: function
            AWS_ACCESS_KEY_ID: dummy
            AWS_SECRET_ACCESS_KEY: dummy
            AWS_REGION: us-east-1
            TEST_MODE: true
            CONCURRENCY_LIMIT: 1
          - PROVIDER: azure
            INFRAWEAVE_ENV: dev
            INFRAWEAVE_API_FUNCTION: function
            AZURE_CLIENT_ID: dummy
            AZURE_CLIENT_SECRET: dummy
            AZURE_TENANT_ID: dummy
            REGION: westus2
            TEST_MODE: true
            CONCURRENCY_LIMIT: 1
        test: ${{ fromJson(needs.integration-tests-matrix.outputs.tests) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@9d84900f3238fab8cd84ce47d658d25dd008be2f
        with:
          tofu_version: 1.11.4

      - name: Alias tofu as terraform
        run: sudo ln -sf $(which tofu) /usr/local/bin/terraform

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: false

      - name: Download archive
        uses: actions/download-artifact@v4
        with:
          name: nextest-archive

      - name: Run nextest
        run: |
          FILTER='package(integration-tests) & binary(${{ matrix.test }})'
          if ! cargo nextest list --archive-file nextest-archive.tar.zst -E "$FILTER" -- --include-ignored | grep -q "::"; then
            echo "No tests found matching filter: $FILTER"
            exit 1
          fi
          cargo nextest run --archive-file nextest-archive.tar.zst -E "$FILTER" -j 1 --no-tests=warn
        env: ${{ matrix.provider }}
